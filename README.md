# 小夜的记忆插件

> AstrBot 插件
>
> 这是一个用于为小夜提供记忆功能的插件。

## 记忆库
### 数据结构

记忆数据是以 JSON 格式存储的，一个用户的记忆文件`{user_id}.json`的数据结构如下：

```json
{
  "user_id": 123456789,
  "count": 1,
  "memory": [
    {
        "id": 1,
        "content": "小夜喜欢吃草莓",
        "time": 1690000000,
        "importance": 1,
        "last_access_time": 1690000000,
        "valid_time": 86400
    }
  ]
}
```
- `user_id`: 用户 ID
- `count`: 记忆数量
- `memory`: 记忆列表
  - `id`: 记忆 ID
  - `content`: 记忆内容
  - `time`: 记忆时间戳
  - `importance`: 重要性评分
  - `last_access_time`: 最后访问时间戳
  - `valid_time`: 记忆有效时间（单位：秒）

### 如何执行一次记忆

为了较为准确地模拟，一次记忆的流程遵循以下步骤：

```
用户输入 -> 查询相关记忆 |-> 记忆超过有效时间 -> 记忆删除 |-> 查询结果
                     |-> 记忆有效时间 -> 记忆访问     |
查询结果 -> llm决定更改记忆/增加记忆
```

建议增加如下提示词
```
你需要先查询(search_memory)相关记忆以提供更贴合的回答，然后决定增加(add_memory)新的记忆或者更新(update_memory)现有记忆
```

或者更详细的指引版本如下
```markdown
# 记忆功能使用指南
你可以使用以下工具来操作用户的记忆:
## 查询记忆
当需要了解用户之前提到的信息或你们之前的交流内容时:
- 使用 `search_memory` 工具查询相关记忆
- 参数: `content` (搜索关键词)
- 搜索后记忆会自动更新访问时间，过期记忆会被自动删除
## 添加记忆
当遇到重要信息需要记录时:
- 使用 `add_memory` 工具添加新记忆
- 参数:
  - `content`: 记忆内容
  - `importance`: 重要性评分(1-10)，越高优先级越高
  - `valid_time`: 记忆有效时间(秒)
## 更新记忆
当已有记忆需要修改时:
- 使用 `update_memory` 工具更新已有记忆
- 参数:
  - `id`: 要更新的记忆ID
  - `content`: 更新后的记忆内容
  - `importance`: 更新后的重要性评分
## 记忆使用策略
- 每次用户输入时，主动搜索相关记忆以提供个性化回复
在回复用户前，请考虑是否需要:
1. 查询相关记忆以提供更贴合用户的回答
2. 保存新的重要信息到记忆中
3. 更新已有记忆的内容或重要性
```

### 增操作

与增操作有关的工具有

| 工具/指令 | 类型 | 参数 | 说明 |
| --------- | ---- | ---- | ---- |
| `add_memory` | 函数工具 | `content`, `importance`, `valid_time` | 添加记忆 |
| `/增加记忆` | 指令 | `<user_id>`, `<content>`, `[importance]`, `[valid_time]` | 添加记忆(管理员) |

### 删操作

与删操作有关的工具有

| 工具/指令 | 类型 | 参数 | 说明 |
| --------- | ---- | ---- | ---- |
| `/删除记忆` | 指令 | `user_id`, `<id>` | 删除记忆(管理员) |

数据库自行记忆删除条件：
1. 当查询到的记忆超过有效时间时，删除该记忆
2. 当达到每人最大记忆数量时，按照下列顺序依次删除直到有记忆容量
   1. 删除所有超过有效时间的记忆
   2. 优先删除重要性评分最低的记忆
   3. 相同重要性评分的情况下，删除上次访问时间最早的记忆
   4. 相同访问时间的情况下，删除创建时间最早的记忆

### 查操作

与查操作有关的工具有
| 工具/指令 | 类型 | 参数 | 说明 |
| --------- | ---- | ---- | ---- |
| `search_memory` | 函数工具 | `keyword` | 获取记忆 |
| `/导出记忆` | 指令 | `[keyword]` | 导出记忆 |

### 改操作

与改操作有关的工具有
| 工具/指令 | 类型 | 参数 | 说明 |
| --------- | ---- | ---- | ---- |
| `update_memory` | 函数工具 | `id`, `content`, `importance` | 更新记忆 |
| `/修改记忆` | 指令 | `<user_id>`, `<id>`, `<content>`, `[importance]` | 更新记忆(管理员) |